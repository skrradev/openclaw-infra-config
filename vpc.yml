AWSTemplateFormatVersion: '2010-09-09'
Description: VPC with egress-only networking, public subnet, and restrictive NACLs

Parameters:
  VpcCidr:
    Type: String
    Default: 10.42.0.0/16
    Description: CIDR block for the VPC

  SubnetCidr:
    Type: String
    Default: 10.42.10.0/24
    Description: CIDR block for the egress subnet

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: fastclaws-vpc
        - Key: Project
          Value: fastclaws

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: fastclaws-igw
        - Key: Project
          Value: fastclaws

  GatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  EgressSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref SubnetCidr
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: fastclaws-egress-subnet
        - Key: Project
          Value: fastclaws

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: fastclaws-egress-rt
        - Key: Project
          Value: fastclaws

  DefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: GatewayAttachment
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  EgressSubnetAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref EgressSubnet
      RouteTableId: !Ref RouteTable

  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: No ingress; outbound only for instance-initiated traffic
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: fastclaws-instance-sg
        - Key: Project
          Value: fastclaws

  EgressSubnetNacl:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: fastclaws-egress-nacl
        - Key: Project
          Value: fastclaws

  NaclAssociation:
    Type: AWS::EC2::SubnetNetworkAclAssociation
    Properties:
      SubnetId: !Ref EgressSubnet
      NetworkAclId: !Ref EgressSubnetNacl

  NaclInboundTcpEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref EgressSubnetNacl
      Egress: false
      RuleAction: allow
      RuleNumber: 100
      Protocol: 6
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  NaclInboundUdpEphemeral:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref EgressSubnetNacl
      Egress: false
      RuleAction: allow
      RuleNumber: 110
      Protocol: 17
      CidrBlock: 0.0.0.0/0
      PortRange:
        From: 1024
        To: 65535

  NaclOutboundAll:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref EgressSubnetNacl
      Egress: true
      RuleAction: allow
      RuleNumber: 100
      Protocol: -1
      CidrBlock: 0.0.0.0/0

Outputs:
  VpcId:
    Description: VPC ID
    Value: !Ref VPC

  SubnetId:
    Description: Egress subnet ID
    Value: !Ref EgressSubnet

  InstanceSecurityGroupId:
    Description: Instance security group ID
    Value: !GetAtt InstanceSecurityGroup.GroupId

  SubnetNaclId:
    Description: Egress subnet NACL ID
    Value: !Ref EgressSubnetNacl
